<div class="container-fluid">
    <!-- <app-header></app-header> -->
</div>
<script src="https://d3js.org/d3.v3.min.js" type="text/javascript" ></script>
<!-- webgazer js -->
<script src="./webgazer.js" type="text/javascript" ></script>

<script>
  window.onload = function() {
    alert("Loaded webgazer js");
    var localstorageLabel = 'webgazerGlobalData';
    window.localStorage.setItem(localstorageLabel, null);

    webgazer.setRegression('ridge') /* currently must set regression and tracker */
    .setTracker('clmtrackr')
    .begin()
    .showPredictionPoints(false); /* shows a square every 100 milliseconds where current prediction is */

    function checkIfReady() {
      var feedbackBox = document.getElementById( webgazer.params.faceFeedbackBoxId );

      if (!webgazer.isReady()) {
        setTimeout(checkIfReady, 100);
      }
      // This isn't strictly necessary, but it makes the DOM easier to read
      // to have the z draw order reflect the DOM order.
      else if( typeof(feedbackBox) == 'undefined' || feedbackBox == null ) {
        setTimeout(checkIfReady, 100);
      }
      else
      {
        //begin webGazer js
        webgazer.begin();

        //call function every time interval to get current gaze data

        // setUpGazeDataSystem();
        // Add the SVG component on the top of everything.

        // webgazer.setGazeListener( collisionEyeListener );

      //get access to these predictions
        webgazer.setGazeListener( function(data, elapsedTime) {
            if (data == null) {
                return;
            }
            var xprediction = data.x; //these x coordinates are relative to the viewport
            var yprediction = data.y; //these y coordinates are relative to the viewport
            console.log(elapsedTime); //elapsed time is based on time since begin was called
            alert("X prediction: ",xprediction, " Y prediction: ", yprediction);
        }).begin();
      }
    }

    setTimeout(checkIfReady,100);

  };

  window.onbeforeunload = function() {
    //webgazer.end(); //Uncomment if you want to save the data even if you reload the page.
    window.localStorage.clear(); //Comment out if you want to save data across different sessions
  }

  function setUpGazeDataSystem(){
    var width = window.innerWidth;
    var height = window.innerHeight;

    var numberOfNodes = 200;

    nodes = d3.ramge(numberOfNodes).map(function() { return {radius: Math.random *12 +4}; }),
    nodes[0].radius = 0;
    nodes[0].fixed = true;

    force = d3.layout.force()
    .gravity(0.05)
    .charge(function(d, i) { return i ? 0 : -2000; })
    .nodes(nodes)
    .size([width, height])
    .start();

    var svg = d3.select("body").append("svg")
    .attr("id", collisionSVG)
    .attr("width", width)
    .attr("height", height)
    .style("top", "0px")
    .style("left","0px")
    .style("margin","0px")
    .style("position","absolute")
    .style("z-index", 100000);

  }

    var collisionEyeListener = function(data, clock) {
    if(!data)
      return;

    nodes[0].px = data.x;
    nodes[0].py = data.y;
    force.resume();

    var cl = webgazer.getTracker().clm;
    var whr = webgazer.getVideoPreviewToCameraResolutionRatio();

    var line = d3.select('#eyeline1')
              .attr("x1",data.x)
              .attr("y1",data.y)
              .attr("x2",cl.getCurrentPosition()[27][0] * whr[0])
              .attr("y2",cl.getCurrentPosition()[27][1] * whr[1]);

    var line = d3.select("#eyeline2")
              .attr("x1",data.x)
              .attr("y1",data.y)
              .attr("x2",cl.getCurrentPosition()[32][0] * whr[0])
              .attr("y2",cl.getCurrentPosition()[32][1] * whr[1]);

    var dot = d3.select("#predictionSquare")
              .attr("x",data.x)
              .attr("y",data.y);
  }

</script>

<router-outlet></router-outlet>
