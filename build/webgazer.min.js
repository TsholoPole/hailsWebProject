/** WebGazer.js: Scalable Webcam EyeTracking Using User Interactions 
 * 
 * Copyright (c) 2016-2018, Brown HCI Group 

* Licensed under GPLv3. Companies with a valuation of less than $10M can use WebGazer.js under LGPLv3. 
*/


!function(window){"use strict";window.webgazer=window.webgazer||{};const defaultWindowSize=8,equalizeStep=5,threshold=80,minCorrelation=.78,maxCorrelation=.85;webgazer.BlinkDetector=function(blinkWindow){this.blinkWindow=blinkWindow||8,this.blinkData=new webgazer.util.DataWindow(this.blinkWindow)},webgazer.BlinkDetector.prototype.extractBlinkData=function(eyesObj){const eye=eyesObj.right,grayscaled=webgazer.util.grayscale(eye.patch.data,eye.width,eye.height),equalized=webgazer.util.equalizeHistogram(grayscaled,5,grayscaled),thresholded=webgazer.util.threshold(equalized,80);return{data:thresholded,width:eye.width,height:eye.height}},webgazer.BlinkDetector.prototype.isSameEye=function(oldEye,newEye){return oldEye.width===newEye.width&&oldEye.height===newEye.height},webgazer.BlinkDetector.prototype.isBlink=function(oldEye,newEye){let correlation=0;for(let i=0;i<this.blinkWindow;i++){const data=this.blinkData.get(i),nextData=this.blinkData.get(i+1);if(!this.isSameEye(data,nextData))return!1;correlation+=webgazer.util.correlation(data.data,nextData.data)}return(correlation/=this.blinkWindow)>.78&&correlation<.85},webgazer.BlinkDetector.prototype.detectBlink=function(eyesObj){if(!eyesObj||!webgazer.params.blinkDetectionOn)return eyesObj;const data=this.extractBlinkData(eyesObj);return this.blinkData.push(data),eyesObj.left.blink=!1,eyesObj.right.blink=!1,this.blinkData.length<this.blinkWindow?eyesObj:(this.isBlink()&&(eyesObj.left.blink=!0,eyesObj.right.blink=!0),eyesObj)},webgazer.BlinkDetector.prototype.setBlinkWindow=function(value){return webgazer.utils.isInt(value)&&value>0&&(this.blinkWindow=value),this}}(window),function(window){"use strict";window.webgazer=window.webgazer||{},webgazer.tracker=webgazer.tracker||{},webgazer.util=webgazer.util||{},webgazer.params=webgazer.params||{};var ClmGaze=function(){this.clm=new clm.tracker(webgazer.params.camConstraints),this.clm.init(pModel);var F=[[1,0,0,0,1,0],[0,1,0,0,0,1],[0,0,1,0,1,0],[0,0,0,1,0,1],[0,0,0,0,1,0],[0,0,0,0,0,1]],Q=[[.25,0,0,0,.5,0],[0,.25,0,0,0,.5],[0,0,.25,0,.5,0],[0,0,0,.25,0,.5],[.5,0,.5,0,1,0],[0,.5,0,.5,0,1]],delta_t=.1;Q=numeric.mul(Q,.1);var H=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0]],pixel_error=6.5,R=numeric.mul(numeric.identity(4),6.5),P_initial=numeric.mul(numeric.identity(6),1e-4),x_initial=[[200],[150],[250],[180],[0],[0]];this.leftKalman=new self.webgazer.util.KalmanFilter(F,H,Q,R,P_initial,x_initial),this.rightKalman=new self.webgazer.util.KalmanFilter(F,H,Q,R,P_initial,x_initial)};webgazer.tracker.ClmGaze=ClmGaze,ClmGaze.prototype.getEyePatches=function(imageCanvas,width,height){if(0===imageCanvas.width)return null;var positions=this.clm.track(imageCanvas),score=this.clm.getScore();if(!positions)return!1;var leftOriginX=positions[23][0],leftOriginY=positions[24][1],leftWidth=positions[25][0]-positions[23][0],leftHeight=positions[26][1]-positions[24][1],rightOriginX=positions[30][0],rightOriginY=positions[29][1],rightWidth=positions[28][0]-positions[30][0],rightHeight=positions[31][1]-positions[29][1],leftBox=[leftOriginX,leftOriginY,leftOriginX+leftWidth,leftOriginY+leftHeight];webgazer.params.smoothEyeBB&&(leftBox=this.leftKalman.update(leftBox)),leftOriginX=Math.round(leftBox[0]),leftOriginY=Math.round(leftBox[1]),leftWidth=Math.round(leftBox[2]-leftBox[0]),leftHeight=Math.round(leftBox[3]-leftBox[1]);var rightBox=[rightOriginX,rightOriginY,rightOriginX+rightWidth,rightOriginY+rightHeight];if(webgazer.params.smoothEyeBB&&(rightBox=this.rightKalman.update(rightBox)),rightOriginX=Math.round(rightBox[0]),rightOriginY=Math.round(rightBox[1]),rightWidth=Math.round(rightBox[2]-rightBox[0]),rightHeight=Math.round(rightBox[3]-rightBox[1]),0===leftWidth||0===rightWidth)return console.log("an eye patch had zero width"),null;if(0===leftHeight||0===rightHeight)return console.log("an eye patch had zero height"),null;var eyeObjs={};eyeObjs.positions=positions;var leftImageData=imageCanvas.getContext("2d").getImageData(leftOriginX,leftOriginY,leftWidth,leftHeight);eyeObjs.left={patch:leftImageData,imagex:leftOriginX,imagey:leftOriginY,width:leftWidth,height:leftHeight};var rightImageData=imageCanvas.getContext("2d").getImageData(rightOriginX,rightOriginY,rightWidth,rightHeight);return eyeObjs.right={patch:rightImageData,imagex:rightOriginX,imagey:rightOriginY,width:rightWidth,height:rightHeight},eyeObjs},ClmGaze.prototype.reset=function(){this.clm.reset()},ClmGaze.prototype.name="clmtrackr"}(window),function(window){"use strict";window.webgazer=window.webgazer||{},webgazer.tracker=webgazer.tracker||{};var TrackingjsGaze=function(){};webgazer.tracker.TrackingjsGaze=TrackingjsGaze,TrackingjsGaze.prototype.getEyePatches=function(imageCanvas,width,height){if(0===imageCanvas.width)return null;var workingImage=imageCanvas.getContext("2d").getImageData(0,0,width,height),face=this.detectFace(workingImage,width,height),offsetX=0,offsetY=0;!(face.length>0)||isNaN(face[0])||isNaN(face[1])||isNaN(face[2])||isNaN(face[3])||(workingImage=imageCanvas.getContext("2d").getImageData(Math.floor(face[0]),Math.floor(face[1]),Math.floor(face[2]),Math.floor(face[3]/2)),width=Math.floor(face[2]),height=Math.floor(face[3]/2),offsetX=Math.floor(face[0]),offsetY=Math.floor(face[1]));var eyes=this.detectEyes(workingImage,width,height);if(console.log(eyes),null===eyes)return null;var eyeObjs={},leftImageData=imageCanvas.getContext("2d").getImageData(Math.floor(eyes[0][0])+offsetX,Math.floor(eyes[0][1])+offsetY,Math.floor(eyes[0][2]),Math.floor(eyes[0][3]));eyeObjs.left={patch:leftImageData,imagex:eyes[0][0]+offsetX,imagey:eyes[0][1]+offsetY,width:eyes[0][2],height:eyes[0][3]};var rightImageData=imageCanvas.getContext("2d").getImageData(Math.floor(eyes[1][0])+offsetX,Math.floor(eyes[1][1])+offsetY,Math.floor(eyes[1][2]),Math.floor(eyes[1][3]));return eyeObjs.right={patch:rightImageData,imagex:eyes[1][0]+offsetX,imagey:eyes[1][1]+offsetY,width:eyes[1][2],height:eyes[1][3]},0===leftImageData.width||0===rightImageData.width?(console.log("an eye patch had zero width"),null):eyeObjs},TrackingjsGaze.prototype.detectEyes=function(workingImage,width,height){var eyes=[],intermediateEyes=[],pixels=workingImage.data;if(tracking.ViolaJones.detect(pixels,width,height,.5,2,1.7,.1,tracking.ViolaJones.classifiers.eye).forEach(function(rect){var intermediateEye=[rect.x,rect.y,rect.width,rect.height];intermediateEyes.push(intermediateEye)}),intermediateEyes.length>1){for(var minimumYDistance=1e3,eyes=[],i=0;i<intermediateEyes.length;i++)for(var j=i+1;j<intermediateEyes.length;j++){var YDistance=Math.abs(Math.floor(intermediateEyes[i][1])-Math.floor(intermediateEyes[j][1]));YDistance<=minimumYDistance&&(minimumYDistance=YDistance,eyes[0]=intermediateEyes[i],eyes[1]=intermediateEyes[j])}return eyes.sort(function(a,b){return a[0]-b[0]}),eyes}return console.log("tracking.js could not detect two eyes in the video"),null},TrackingjsGaze.prototype.detectFace=function(workingImage,width,height){var intermediateFaces=[],face=[],pixels=workingImage.data;return tracking.ViolaJones.detect(pixels,width,height,2,1.25,2,.1,tracking.ViolaJones.classifiers.face).forEach(function(rect){var intermediateFace=[rect.x,rect.y,rect.width,rect.height];intermediateFaces.push(intermediateFace)}),face=this.findLargestRectangle(intermediateFaces)},TrackingjsGaze.prototype.findLargestRectangle=function(rectangles){for(var largestArea=0,area=0,largestRectangle=[],i=0;i<rectangles.length;++i)(area=rectangles[i][2]*rectangles[i][3])>largestArea&&(largestArea=area,largestRectangle=rectangles[i]);return largestRectangle},TrackingjsGaze.prototype.reset=function(){console.log("Unimplemented; Tracking.js has no obvious reset function")},TrackingjsGaze.prototype.name="trackingjs"}(window),function(window){"use strict";window.webgazer=window.webgazer||{},webgazer.tracker=webgazer.tracker||{};var Js_objectdetectGaze=function(){};webgazer.tracker.Js_objectdetectGaze=Js_objectdetectGaze,Js_objectdetectGaze.prototype.getEyePatches=function(imageCanvas,width,height){if(0===imageCanvas.width)return null;var workingImage=imageCanvas.getContext("2d").getImageData(0,0,width,height),face=this.detectFace(imageCanvas,width,height),offsetX=0,offsetY=0;!(face.length>0)||isNaN(face[0])||isNaN(face[1])||isNaN(face[2])||isNaN(face[3])||(workingImage=imageCanvas.getContext("2d").getImageData(Math.floor(face[0]),Math.floor(face[1]),Math.floor(face[2]),Math.floor(face[3]/2)),width=Math.floor(face[2]),height=Math.floor(face[3]/2),offsetX=Math.floor(face[0]),offsetY=Math.floor(face[1]));var eyes=this.detectEyes(workingImage,width,height);if(null===eyes)return null;var eyeObjs={},leftImageData=imageCanvas.getContext("2d").getImageData(Math.floor(eyes[0][0])+offsetX,Math.floor(eyes[0][1])+offsetY,Math.floor(eyes[0][2]),Math.floor(eyes[0][3]));eyeObjs.left={patch:leftImageData,imagex:eyes[0][0]+offsetX,imagey:eyes[0][1]+offsetY,width:eyes[0][2],height:eyes[0][3]};var rightImageData=imageCanvas.getContext("2d").getImageData(Math.floor(eyes[1][0])+offsetX,Math.floor(eyes[1][1])+offsetY,Math.floor(eyes[1][2]),Math.floor(eyes[1][3]));return eyeObjs.right={patch:rightImageData,imagex:eyes[1][0]+offsetX,imagey:eyes[1][1]+offsetY,width:eyes[1][2],height:eyes[1][3]},0===leftImageData.width||0===rightImageData.width?(console.log("an eye patch had zero width"),null):eyeObjs},Js_objectdetectGaze.prototype.detectEyes=function(workingImage,workingImageWidth,workingImageHeight){var tempCanvas=document.createElement("canvas");tempCanvas.width=workingImageWidth,tempCanvas.height=workingImageHeight,tempCanvas.getContext("2d").putImageData(workingImage,0,0);var eyes=[],intermediateEyes=[],width=~~(60*workingImageWidth/workingImageHeight),height=60,detector=new objectdetect.detector(width,60,1.1,objectdetect.eye);if(intermediateEyes=detector.detect(tempCanvas,0),void 0!==(eyes=this.mergeRectangles(intermediateEyes))){for(var i=0;i<eyes.length;i++)eyes[i][0]*=workingImageWidth/detector.canvas.width,eyes[i][1]*=workingImageHeight/detector.canvas.height,eyes[i][2]*=workingImageWidth/detector.canvas.width,eyes[i][3]*=workingImageHeight/detector.canvas.height;return eyes.sort(function(a,b){return a[0]-b[0]}),eyes}return console.log("js_objectdetect could not detect two eyes in the video"),null},Js_objectdetectGaze.prototype.detectFace=function(imageCanvas,workingImageWidth,workingImageHeight){var intermediateFaces=[],face=[],width=~~(60*workingImageWidth/workingImageHeight),height=60,detector=new objectdetect.detector(width,60,1.1,objectdetect.frontalface_alt);return intermediateFaces=detector.detect(imageCanvas,1),(face=this.findLargestRectangle(intermediateFaces))[0]*=workingImageWidth/detector.canvas.width,face[1]*=workingImageHeight/detector.canvas.height,face[2]*=workingImageWidth/detector.canvas.width,face[3]*=workingImageHeight/detector.canvas.height,face},Js_objectdetectGaze.prototype.findLargestRectangle=function(rectangles){for(var largestArea=0,area=0,largestRectangle=[],i=0;i<rectangles.length;++i)(area=rectangles[i][2]*rectangles[i][3])>largestArea&&(largestArea=area,largestRectangle=rectangles[i]);return largestRectangle},Js_objectdetectGaze.prototype.mergeRectangles=function(rects){for(var disjointSet=new tracking.DisjointSet(rects.length),i=0;i<rects.length;i++)for(var r1=rects[i],j=0;j<rects.length;j++){var r2=rects[j];if(tracking.Math.intersectRect(r1[0],r1[1],r1[0]+r1[2],r1[1]+r1[3],r2[0],r2[1],r2[0]+r2[2],r2[1]+r2[3])){var x1=Math.max(r1[0],r2[0]),y1=Math.max(r1[1],r2[1]),x2,y2,overlap=(x1-Math.min(r1[0]+r1[2],r2[0]+r2[2]))*(y1-Math.min(r1[1]+r1[3],r2[1]+r2[3])),area1=r1[2]*r1[3],area2=r2[2]*r2[3];overlap/(area1*(area1/area2))>=.5&&overlap/(area2*(area1/area2))>=.5&&disjointSet.union(i,j)}}for(var map={},k=0;k<disjointSet.length;k++){var rep=disjointSet.find(k);map[rep]?(map[rep].total++,map[rep].width+=rects[k][2],map[rep].height+=rects[k][3],map[rep].x+=rects[k][0],map[rep].y+=rects[k][1]):map[rep]={total:1,width:rects[k][2],height:rects[k][3],x:rects[k][0],y:rects[k][1]}}var result=[];return Object.keys(map).forEach(function(key){var rect=map[key];result.push([rect.x/rect.total+.5|0,rect.y/rect.total+.5|0,rect.width/rect.total+.5|0,rect.height/rect.total+.5|0])}),result},Js_objectdetectGaze.prototype.reset=function(){console.log("Unimplemented; js_objectdetect.js has no obvious reset function")},Js_objectdetectGaze.prototype.name="js_objectdetect"}(window),function(window){window.webgazer=window.webgazer||{},webgazer.reg=webgazer.reg||{},webgazer.pupil=webgazer.pupil||{},webgazer.reg.LinearReg=function(){this.leftDatasetX=[],this.leftDatasetY=[],this.rightDatasetX=[],this.rightDatasetY=[],this.data=[]},webgazer.reg.LinearReg.prototype.addData=function(eyes,screenPos,type){eyes&&(webgazer.pupil.getPupils(eyes),eyes.left.blink||(this.leftDatasetX.push([eyes.left.pupil[0][0],screenPos[0]]),this.leftDatasetY.push([eyes.left.pupil[0][1],screenPos[1]])),eyes.right.blink||(this.rightDatasetX.push([eyes.right.pupil[0][0],screenPos[0]]),this.rightDatasetY.push([eyes.right.pupil[0][1],screenPos[1]])),this.data.push({eyes:eyes,screenPos:screenPos,type:type}))},webgazer.reg.LinearReg.prototype.setData=function(data){for(var i=0;i<data.length;i++)this.addData(data[i].eyes,data[i].screenPos,data[i].type);this.data=data},webgazer.reg.LinearReg.prototype.getData=function(){return this.data},webgazer.reg.LinearReg.prototype.predict=function(eyesObj){if(!eyesObj)return null;var result=regression("linear",this.leftDatasetX),leftSlopeX=result.equation[0],leftIntersceptX=result.equation[1],leftSlopeY=(result=regression("linear",this.leftDatasetY)).equation[0],leftIntersceptY=result.equation[1],rightSlopeX=(result=regression("linear",this.rightDatasetX)).equation[0],rightIntersceptX=result.equation[1],rightSlopeY=(result=regression("linear",this.rightDatasetY)).equation[0],rightIntersceptY=result.equation[1];webgazer.pupil.getPupils(eyesObj);var leftPupilX=eyesObj.left.pupil[0][0],leftPupilY=eyesObj.left.pupil[0][1],rightPupilX=eyesObj.right.pupil[0][0],rightPupilY=eyesObj.right.pupil[0][1],predictedX,predictedY;return{x:Math.floor((leftSlopeX*leftPupilX+leftIntersceptX+(rightSlopeX*rightPupilX+rightIntersceptX))/2),y:Math.floor((leftSlopeY*leftPupilY+leftIntersceptY+(rightSlopeY*rightPupilY+rightIntersceptY))/2)}},webgazer.reg.LinearReg.prototype.name="simple"}(window),function(){"use strict";self.webgazer=self.webgazer||{},self.webgazer.mat=self.webgazer.mat||{},self.webgazer.mat.transpose=function(matrix){for(var m=matrix.length,n=matrix[0].length,transposedMatrix=new Array(n),i=0;i<m;i++)for(var j=0;j<n;j++)0===i&&(transposedMatrix[j]=new Array(m)),transposedMatrix[j][i]=matrix[i][j];return transposedMatrix},self.webgazer.mat.getMatrix=function(matrix,r,j0,j1){for(var X=new Array(r.length),m=j1-j0+1,i=0;i<r.length;i++){X[i]=new Array(m);for(var j=j0;j<=j1;j++)X[i][j-j0]=matrix[r[i]][j]}return X},self.webgazer.mat.getSubMatrix=function(matrix,i0,i1,j0,j1){for(var size=j1-j0+1,X=new Array(i1-i0+1),i=i0;i<=i1;i++){var subI=i-i0;X[subI]=new Array(size);for(var j=j0;j<=j1;j++)X[subI][j-j0]=matrix[i][j]}return X},self.webgazer.mat.mult=function(matrix1,matrix2){matrix2.length!=matrix1[0].length&&console.log("Matrix inner dimensions must agree.");for(var X=new Array(matrix1.length),Bcolj=new Array(matrix1[0].length),j=0;j<matrix2[0].length;j++){for(var k=0;k<matrix1[0].length;k++)Bcolj[k]=matrix2[k][j];for(var i=0;i<matrix1.length;i++){0===j&&(X[i]=new Array(matrix2[0].length));for(var Arowi=matrix1[i],s=0,k=0;k<matrix1[0].length;k++)s+=Arowi[k]*Bcolj[k];X[i][j]=s}}return X},self.webgazer.mat.LUDecomposition=function(A,B){for(var LU=new Array(A.length),i=0;i<A.length;i++){LU[i]=new Array(A[0].length);for(var j=0;j<A[0].length;j++)LU[i][j]=A[i][j]}for(var m=A.length,n=A[0].length,piv=new Array(m),i=0;i<m;i++)piv[i]=i;for(var pivsign=1,LUrowi=new Array,LUcolj=new Array(m),j=0;j<n;j++){for(var i=0;i<m;i++)LUcolj[i]=LU[i][j];for(var i=0;i<m;i++){LUrowi=LU[i];for(var kmax=Math.min(i,j),s=0,k=0;k<kmax;k++)s+=LUrowi[k]*LUcolj[k];LUrowi[j]=LUcolj[i]-=s}for(var p=j,i=j+1;i<m;i++)Math.abs(LUcolj[i])>Math.abs(LUcolj[p])&&(p=i);if(p!=j){for(var k=0;k<n;k++){var t=LU[p][k];LU[p][k]=LU[j][k],LU[j][k]=t}var k=piv[p];piv[p]=piv[j],piv[j]=k,pivsign=-pivsign}if(j<m&0!=LU[j][j])for(var i=j+1;i<m;i++)LU[i][j]/=LU[j][j]}B.length!=m&&console.log("Matrix row dimensions must agree.");for(var j=0;j<n;j++)0===LU[j][j]&&console.log("Matrix is singular.");for(var nx=B[0].length,X=self.webgazer.mat.getMatrix(B,piv,0,nx-1),k=0;k<n;k++)for(var i=k+1;i<n;i++)for(var j=0;j<nx;j++)X[i][j]-=X[k][j]*LU[i][k];for(var k=n-1;k>=0;k--){for(var j=0;j<nx;j++)X[k][j]/=LU[k][k];for(var i=0;i<k;i++)for(var j=0;j<nx;j++)X[i][j]-=X[k][j]*LU[i][k]}return X},self.webgazer.mat.QRDecomposition=function(A,B){for(var QR=new Array(A.length),i=0;i<A.length;i++){QR[i]=new Array(A[0].length);for(var j=0;j<A[0].length;j++)QR[i][j]=A[i][j]}for(var m=A.length,n=A[0].length,Rdiag=new Array(n),nrm,k=0;k<n;k++){nrm=0;for(var i=k;i<m;i++)nrm=Math.hypot(nrm,QR[i][k]);if(0!=nrm){QR[k][k]<0&&(nrm=-nrm);for(var i=k;i<m;i++)QR[i][k]/=nrm;QR[k][k]+=1;for(var j=k+1;j<n;j++){for(var s=0,i=k;i<m;i++)s+=QR[i][k]*QR[i][j];s=-s/QR[k][k];for(var i=k;i<m;i++)QR[i][j]+=s*QR[i][k]}}Rdiag[k]=-nrm}B.length!=m&&console.log("Matrix row dimensions must agree.");for(var j=0;j<n;j++)0===Rdiag[j]&&console.log("Matrix is rank deficient");for(var nx=B[0].length,X=new Array(B.length),i=0;i<B.length;i++)X[i]=new Array(B[0].length);for(var i=0;i<B.length;i++)for(var j=0;j<B[0].length;j++)X[i][j]=B[i][j];for(var k=0;k<n;k++)for(var j=0;j<nx;j++){for(var s=0,i=k;i<m;i++)s+=QR[i][k]*X[i][j];s=-s/QR[k][k];for(var i=k;i<m;i++)X[i][j]+=s*QR[i][k]}for(var k=n-1;k>=0;k--){for(var j=0;j<nx;j++)X[k][j]/=Rdiag[k];for(var i=0;i<k;i++)for(var j=0;j<nx;j++)X[i][j]-=X[k][j]*QR[i][k]}return self.webgazer.mat.getSubMatrix(X,0,n-1,0,nx-1)}}(),function(window){window.webgazer=window.webgazer||{},webgazer.pupil=webgazer.pupil||{};var getValue=function(pixels,x,y,width){return pixels[y*width+x]},getSumTable=function(pixels,width,height){for(var integralImage=new Array(width),sumx=0,sumy=0,i=0;i<width;i++)integralImage[i]=new Array(height),sumx+=getValue(pixels,i,0,width),integralImage[i][0]=sumx;for(var i=0;i<height;i++)sumy+=getValue(pixels,0,i,width),integralImage[0][i]=sumy;for(var x=1;x<width;x++)for(var y=1;y<height;y++)integralImage[x][y]=getValue(pixels,x,y,width)+integralImage[x-1][y]+integralImage[x][y-1]-integralImage[x-1][y-1];return integralImage},getSinglePupil=function(pixels,width,height){for(var summedAreaTable=getSumTable(pixels,width,height),bestAvgScore=999999,bestPoint=[0,0],bestHalfWidth=0,offset=Math.floor(width/10),halfWidth=Math.floor(height/10);halfWidth<width/2;halfWidth++)for(var x=halfWidth;x<width-offset;x++)for(var y=halfWidth;y<height-offset;y++){var irisArea=summedAreaTable[x+offset][y+offset]+summedAreaTable[x+offset-halfWidth][y+offset-halfWidth]-summedAreaTable[x+offset][y+offset-halfWidth]-summedAreaTable[x+offset-halfWidth][y+offset],avgScore=1*irisArea/((halfWidth+1)*(halfWidth+1))+1,scleraIrisArea=1*summedAreaTable[width-1-offset][y+offset]+summedAreaTable[0+offset][y+offset-halfWidth]-summedAreaTable[0+offset][y+offset]-summedAreaTable[width-1-offset][y+offset-halfWidth]-irisArea;avgScore/scleraIrisArea<bestAvgScore&&avgScore<150&&(bestAvgScore=avgScore/scleraIrisArea,bestPoint=[x+offset,y+offset],bestHalfWidth=halfWidth)}return[bestPoint,bestHalfWidth]};webgazer.pupil.getPupils=function(eyesObj){return eyesObj?(eyesObj.left.blink||(eyesObj.left.pupil=getSinglePupil(Array.prototype.slice.call(webgazer.util.grayscale(eyesObj.left.patch.data,eyesObj.left.width,eyesObj.left.height)),eyesObj.left.width,eyesObj.left.height),eyesObj.left.pupil[0][0]-=eyesObj.left.pupil[1],eyesObj.left.pupil[0][1]-=eyesObj.left.pupil[1]),eyesObj.right.blink||(eyesObj.right.pupil=getSinglePupil(Array.prototype.slice.call(webgazer.util.grayscale(eyesObj.right.patch.data,eyesObj.right.width,eyesObj.right.height)),eyesObj.right.width,eyesObj.right.height),eyesObj.right.pupil[0][0]-=eyesObj.right.pupil[1],eyesObj.right.pupil[0][1]-=eyesObj.right.pupil[1]),eyesObj):eyesObj}}(window),function(){"use strict";var gaussianElimination=function(a,o){var i=0,j=0,k=0,maxrow=0,tmp=0,n=a.length-1,x=new Array(o);for(i=0;i<n;i++){for(maxrow=i,j=i+1;j<n;j++)Math.abs(a[i][j])>Math.abs(a[i][maxrow])&&(maxrow=j);for(k=i;k<n+1;k++)tmp=a[k][i],a[k][i]=a[k][maxrow],a[k][maxrow]=tmp;for(j=i+1;j<n;j++)for(k=n;k>=i;k--)a[k][j]-=a[k][i]*a[i][j]/a[i][i]}for(j=n-1;j>=0;j--){for(tmp=0,k=j+1;k<n;k++)tmp+=a[k][j]*x[k];x[j]=(a[n][j]-tmp)/a[j][j]}return x},methods={linear:function(data){for(var sum=[0,0,0,0,0],n=0,results=[];n<data.length;n++)null!=data[n][1]&&(sum[0]+=data[n][0],sum[1]+=data[n][1],sum[2]+=data[n][0]*data[n][0],sum[3]+=data[n][0]*data[n][1],sum[4]+=data[n][1]*data[n][1]);for(var gradient=(n*sum[3]-sum[0]*sum[1])/(n*sum[2]-sum[0]*sum[0]),intercept=sum[1]/n-gradient*sum[0]/n,i=0,len=data.length;i<len;i++){var coordinate=[data[i][0],data[i][0]*gradient+intercept];results.push(coordinate)}var string;return{equation:[gradient,intercept],points:results,string:"y = "+Math.round(100*gradient)/100+"x + "+Math.round(100*intercept)/100}},linearThroughOrigin:function(data){for(var sum=[0,0],n=0,results=[];n<data.length;n++)null!=data[n][1]&&(sum[0]+=data[n][0]*data[n][0],sum[1]+=data[n][0]*data[n][1]);for(var gradient=sum[1]/sum[0],i=0,len=data.length;i<len;i++){var coordinate=[data[i][0],data[i][0]*gradient];results.push(coordinate)}var string;return{equation:[gradient],points:results,string:"y = "+Math.round(100*gradient)/100+"x"}},exponential:function(data){var sum=[0,0,0,0,0,0],n=0,results=[],string;for(len=data.length;n<len;n++)null!=data[n][1]&&(sum[0]+=data[n][0],sum[1]+=data[n][1],sum[2]+=data[n][0]*data[n][0]*data[n][1],sum[3]+=data[n][1]*Math.log(data[n][1]),sum[4]+=data[n][0]*data[n][1]*Math.log(data[n][1]),sum[5]+=data[n][0]*data[n][1]);for(var denominator=sum[1]*sum[2]-sum[5]*sum[5],A=Math.pow(Math.E,(sum[2]*sum[3]-sum[5]*sum[4])/denominator),B=(sum[1]*sum[4]-sum[5]*sum[3])/denominator,i=0,len=data.length;i<len;i++){var coordinate=[data[i][0],A*Math.pow(Math.E,B*data[i][0])];results.push(coordinate)}return{equation:[A,B],points:results,string:"y = "+Math.round(100*A)/100+"e^("+Math.round(100*B)/100+"x)"}},logarithmic:function(data){var sum=[0,0,0,0],n=0,results=[],string;for(len=data.length;n<len;n++)null!=data[n][1]&&(sum[0]+=Math.log(data[n][0]),sum[1]+=data[n][1]*Math.log(data[n][0]),sum[2]+=data[n][1],sum[3]+=Math.pow(Math.log(data[n][0]),2));for(var B=(n*sum[1]-sum[2]*sum[0])/(n*sum[3]-sum[0]*sum[0]),A=(sum[2]-B*sum[0])/n,i=0,len=data.length;i<len;i++){var coordinate=[data[i][0],A+B*Math.log(data[i][0])];results.push(coordinate)}return{equation:[A,B],points:results,string:"y = "+Math.round(100*A)/100+" + "+Math.round(100*B)/100+" ln(x)"}},power:function(data){var sum=[0,0,0,0],n=0,results=[],string;for(len=data.length;n<len;n++)null!=data[n][1]&&(sum[0]+=Math.log(data[n][0]),sum[1]+=Math.log(data[n][1])*Math.log(data[n][0]),sum[2]+=Math.log(data[n][1]),sum[3]+=Math.pow(Math.log(data[n][0]),2));for(var B=(n*sum[1]-sum[2]*sum[0])/(n*sum[3]-sum[0]*sum[0]),A=Math.pow(Math.E,(sum[2]-B*sum[0])/n),i=0,len=data.length;i<len;i++){var coordinate=[data[i][0],A*Math.pow(data[i][0],B)];results.push(coordinate)}return{equation:[A,B],points:results,string:"y = "+Math.round(100*A)/100+"x^"+Math.round(100*B)/100}},polynomial:function(data,order){void 0===order&&(order=2);for(var lhs=[],rhs=[],results=[],a=0,b=0,i=0,k=order+1;i<k;i++){for(var l=0,len=data.length;l<len;l++)null!=data[l][1]&&(a+=Math.pow(data[l][0],i)*data[l][1]);lhs.push(a),a=0;for(var c=[],j=0;j<k;j++){for(var l=0,len=data.length;l<len;l++)null!=data[l][1]&&(b+=Math.pow(data[l][0],i+j));c.push(b),b=0}rhs.push(c)}rhs.push(lhs);for(var equation=gaussianElimination(rhs,k),i=0,len=data.length;i<len;i++){for(var answer=0,w=0;w<equation.length;w++)answer+=equation[w]*Math.pow(data[i][0],w);results.push([data[i][0],answer])}for(var string="y = ",i=equation.length-1;i>=0;i--)string+=i>1?Math.round(equation[i]*Math.pow(10,i))/Math.pow(10,i)+"x^"+i+" + ":1===i?Math.round(100*equation[i])/100+"x + ":Math.round(100*equation[i])/100;return{equation:equation,points:results,string:string}},lastvalue:function(data){for(var results=[],lastvalue=null,i=0;i<data.length;i++)data[i][1]?(lastvalue=data[i][1],results.push([data[i][0],data[i][1]])):results.push([data[i][0],lastvalue]);return{equation:[lastvalue],points:results,string:""+lastvalue}}},regression=function(method,data,order){if("string"==typeof method)return methods[method](data,order)};"undefined"!=typeof exports?module.exports=regression:window.regression=regression}(),function(window){window.webgazer=window.webgazer||{},webgazer.reg=webgazer.reg||{},webgazer.mat=webgazer.mat||{},webgazer.util=webgazer.util||{},webgazer.params=webgazer.params||{};var ridgeParameter=Math.pow(10,-5),resizeWidth=10,resizeHeight=6,dataWindow=700,trailDataWindow=10;function ridge(y,X,k){var nc=X[0].length,m_Coefficients=new Array(nc),xt=webgazer.mat.transpose(X),solution=new Array,success=!0;do{for(var ss=webgazer.mat.mult(xt,X),i=0;i<nc;i++)ss[i][i]=ss[i][i]+k;for(var bb=webgazer.mat.mult(xt,y),i=0;i<nc;i++)m_Coefficients[i]=bb[i][0];try{var n=0!==m_Coefficients.length?m_Coefficients.length/m_Coefficients.length:0;m_Coefficients.length*n!==m_Coefficients.length&&console.log("Array length must be a multiple of m"),solution=ss.length===ss[0].length?numeric.LUsolve(numeric.LU(ss,!0),bb):webgazer.mat.QRDecomposition(ss,bb);for(var i=0;i<nc;i++)m_Coefficients[i]=solution[i];success=!0}catch(ex){k*=10,console.log(ex),success=!1}}while(!success);return m_Coefficients}function getEyeFeats(eyes){var resizedLeft=webgazer.util.resizeEye(eyes.left,resizeWidth,resizeHeight),resizedright=webgazer.util.resizeEye(eyes.right,resizeWidth,resizeHeight),leftGray=webgazer.util.grayscale(resizedLeft.data,resizedLeft.width,resizedLeft.height),rightGray=webgazer.util.grayscale(resizedright.data,resizedright.width,resizedright.height),histLeft=[];webgazer.util.equalizeHistogram(leftGray,5,histLeft);var histRight=[];webgazer.util.equalizeHistogram(rightGray,5,histRight);var leftGrayArray=Array.prototype.slice.call(histLeft),rightGrayArray=Array.prototype.slice.call(histRight);return leftGrayArray.concat(rightGrayArray)}function getCurrentFixationIndex(){for(var index=0,recentX=this.screenXTrailArray.get(0),recentY=this.screenYTrailArray.get(0),i=this.screenXTrailArray.length-1;i>=0;i--){var currX=this.screenXTrailArray.get(i),currY=this.screenYTrailArray.get(i),euclideanDistance;if(Math.sqrt(Math.pow(currX-recentX,2)+Math.pow(currY-recentY,2))>72)return i+1}return i}webgazer.reg.RidgeReg=function(){this.screenXClicksArray=new webgazer.util.DataWindow(700),this.screenYClicksArray=new webgazer.util.DataWindow(700),this.eyeFeaturesClicks=new webgazer.util.DataWindow(700),this.trailTime=1e3,this.trailDataWindow=this.trailTime/webgazer.params.moveTickSize,this.screenXTrailArray=new webgazer.util.DataWindow(10),this.screenYTrailArray=new webgazer.util.DataWindow(10),this.eyeFeaturesTrail=new webgazer.util.DataWindow(10),this.trailTimes=new webgazer.util.DataWindow(10),this.dataClicks=new webgazer.util.DataWindow(700),this.dataTrail=new webgazer.util.DataWindow(700)},webgazer.reg.RidgeReg.prototype.addData=function(eyes,screenPos,type){eyes&&(eyes.left.blink||eyes.right.blink||("click"===type?(this.screenXClicksArray.push([screenPos[0]]),this.screenYClicksArray.push([screenPos[1]]),this.eyeFeaturesClicks.push(getEyeFeats(eyes)),this.dataClicks.push({eyes:eyes,screenPos:screenPos,type:type})):"move"===type&&(this.screenXTrailArray.push([screenPos[0]]),this.screenYTrailArray.push([screenPos[1]]),this.eyeFeaturesTrail.push(getEyeFeats(eyes)),this.trailTimes.push(performance.now()),this.dataTrail.push({eyes:eyes,screenPos:screenPos,type:type}))))},webgazer.reg.RidgeReg.prototype.predict=function(eyesObj){if(!eyesObj||0===this.eyeFeaturesClicks.length)return null;for(var acceptTime=performance.now()-this.trailTime,trailX=[],trailY=[],trailFeat=[],i=0;i<this.trailDataWindow;i++)this.trailTimes.get(i)>acceptTime&&(trailX.push(this.screenXTrailArray.get(i)),trailY.push(this.screenYTrailArray.get(i)),trailFeat.push(this.eyeFeaturesTrail.get(i)));for(var screenXArray=this.screenXClicksArray.data.concat(trailX),screenYArray=this.screenYClicksArray.data.concat(trailY),eyeFeatures=this.eyeFeaturesClicks.data.concat(trailFeat),coefficientsX=ridge(screenXArray,eyeFeatures,ridgeParameter),coefficientsY=ridge(screenYArray,eyeFeatures,ridgeParameter),eyeFeats=getEyeFeats(eyesObj),predictedX=0,i=0;i<eyeFeats.length;i++)predictedX+=eyeFeats[i]*coefficientsX[i];for(var predictedY=0,i=0;i<eyeFeats.length;i++)predictedY+=eyeFeats[i]*coefficientsY[i];return{x:predictedX=Math.floor(predictedX),y:predictedY=Math.floor(predictedY)}},webgazer.reg.RidgeReg.prototype.setData=function(data){for(var i=0;i<data.length;i++)data[i].eyes.left.patch=new ImageData(new Uint8ClampedArray(data[i].eyes.left.patch),data[i].eyes.left.width,data[i].eyes.left.height),data[i].eyes.right.patch=new ImageData(new Uint8ClampedArray(data[i].eyes.right.patch),data[i].eyes.right.width,data[i].eyes.right.height),this.addData(data[i].eyes,data[i].screenPos,data[i].type)},webgazer.reg.RidgeReg.prototype.getData=function(){return this.dataClicks.data.concat(this.dataTrail.data)},webgazer.reg.RidgeReg.prototype.name="ridge"}(window),function(window){window.webgazer=window.webgazer||{},webgazer.reg=webgazer.reg||{},webgazer.mat=webgazer.mat||{},webgazer.util=webgazer.util||{},webgazer.params=webgazer.params||{};var ridgeParameter=Math.pow(10,-5),resizeWidth=10,resizeHeight=6,dataWindow=700,trailDataWindow=10;function ridge(y,X,k){var nc=X[0].length,m_Coefficients=new Array(nc),xt=webgazer.mat.transpose(X),solution=new Array,success=!0;do{for(var ss=webgazer.mat.mult(xt,X),i=0;i<nc;i++)ss[i][i]=ss[i][i]+k;for(var bb=webgazer.mat.mult(xt,y),i=0;i<nc;i++)m_Coefficients[i]=bb[i][0];try{var n=0!==m_Coefficients.length?m_Coefficients.length/m_Coefficients.length:0;m_Coefficients.length*n!==m_Coefficients.length&&console.log("Array length must be a multiple of m"),solution=ss.length===ss[0].length?numeric.LUsolve(numeric.LU(ss,!0),bb):webgazer.mat.QRDecomposition(ss,bb);for(var i=0;i<nc;i++)m_Coefficients[i]=solution[i];success=!0}catch(ex){k*=10,console.log(ex),success=!1}}while(!success);return m_Coefficients}function getEyeFeats(eyes){var resizedLeft=webgazer.util.resizeEye(eyes.left,resizeWidth,resizeHeight),resizedright=webgazer.util.resizeEye(eyes.right,resizeWidth,resizeHeight),leftGray=webgazer.util.grayscale(resizedLeft.data,resizedLeft.width,resizedLeft.height),rightGray=webgazer.util.grayscale(resizedright.data,resizedright.width,resizedright.height),histLeft=[];webgazer.util.equalizeHistogram(leftGray,5,histLeft);var histRight=[];webgazer.util.equalizeHistogram(rightGray,5,histRight);var leftGrayArray=Array.prototype.slice.call(histLeft),rightGrayArray=Array.prototype.slice.call(histRight);return leftGrayArray.concat(rightGrayArray)}function getCurrentFixationIndex(){for(var index=0,recentX=this.screenXTrailArray.get(0),recentY=this.screenYTrailArray.get(0),i=this.screenXTrailArray.length-1;i>=0;i--){var currX=this.screenXTrailArray.get(i),currY=this.screenYTrailArray.get(i),euclideanDistance;if(Math.sqrt(Math.pow(currX-recentX,2)+Math.pow(currY-recentY,2))>72)return i+1}return i}webgazer.reg.RidgeWeightedReg=function(){this.screenXClicksArray=new webgazer.util.DataWindow(700),this.screenYClicksArray=new webgazer.util.DataWindow(700),this.eyeFeaturesClicks=new webgazer.util.DataWindow(700),this.trailTime=1e3,this.trailDataWindow=this.trailTime/webgazer.params.moveTickSize,this.screenXTrailArray=new webgazer.util.DataWindow(10),this.screenYTrailArray=new webgazer.util.DataWindow(10),this.eyeFeaturesTrail=new webgazer.util.DataWindow(10),this.trailTimes=new webgazer.util.DataWindow(10),this.dataClicks=new webgazer.util.DataWindow(700),this.dataTrail=new webgazer.util.DataWindow(700)},webgazer.reg.RidgeWeightedReg.prototype.addData=function(eyes,screenPos,type){eyes&&(eyes.left.blink||eyes.right.blink||("click"===type?(this.screenXClicksArray.push([screenPos[0]]),this.screenYClicksArray.push([screenPos[1]]),this.eyeFeaturesClicks.push(getEyeFeats(eyes)),this.dataClicks.push({eyes:eyes,screenPos:screenPos,type:type})):"move"===type&&(this.screenXTrailArray.push([screenPos[0]]),this.screenYTrailArray.push([screenPos[1]]),this.eyeFeaturesTrail.push(getEyeFeats(eyes)),this.trailTimes.push(performance.now()),this.dataTrail.push({eyes:eyes,screenPos:screenPos,type:type}))))},webgazer.reg.RidgeWeightedReg.prototype.predict=function(eyesObj){if(!eyesObj||0===this.eyeFeaturesClicks.length)return null;for(var acceptTime=performance.now()-this.trailTime,trailX=[],trailY=[],trailFeat=[],i=0;i<this.trailDataWindow;i++)this.trailTimes.get(i)>acceptTime&&(trailX.push(this.screenXTrailArray.get(i)),trailY.push(this.screenYTrailArray.get(i)),trailFeat.push(this.eyeFeaturesTrail.get(i)));for(var len=this.eyeFeaturesClicks.data.length,weightedEyeFeats=Array(len),weightedXArray=Array(len),weightedYArray=Array(len),i=0;i<len;i++){for(var weight=Math.sqrt(1/(len-i)),trueIndex=this.eyeFeaturesClicks.getTrueIndex(i),j=0;j<this.eyeFeaturesClicks.data[trueIndex].length;j++){var val=this.eyeFeaturesClicks.data[trueIndex][j]*weight;void 0!==weightedEyeFeats[trueIndex]?weightedEyeFeats[trueIndex].push(val):weightedEyeFeats[trueIndex]=[val]}weightedXArray[trueIndex]=this.screenXClicksArray.get(i).slice(0,this.screenXClicksArray.get(i).length),weightedYArray[trueIndex]=this.screenYClicksArray.get(i).slice(0,this.screenYClicksArray.get(i).length),weightedXArray[i][0]=weightedXArray[i][0]*weight,weightedYArray[i][0]=weightedYArray[i][0]*weight}for(var screenXArray=weightedXArray.concat(trailX),screenYArray=weightedYArray.concat(trailY),eyeFeatures=weightedEyeFeats.concat(trailFeat),coefficientsX=ridge(screenXArray,eyeFeatures,ridgeParameter),coefficientsY=ridge(screenYArray,eyeFeatures,ridgeParameter),eyeFeats=getEyeFeats(eyesObj),predictedX=0,i=0;i<eyeFeats.length;i++)predictedX+=eyeFeats[i]*coefficientsX[i];for(var predictedY=0,i=0;i<eyeFeats.length;i++)predictedY+=eyeFeats[i]*coefficientsY[i];return{x:predictedX=Math.floor(predictedX),y:predictedY=Math.floor(predictedY)}},webgazer.reg.RidgeWeightedReg.prototype.setData=function(data){for(var i=0;i<data.length;i++)data[i].eyes.left.patch=new ImageData(new Uint8ClampedArray(data[i].eyes.left.patch),data[i].eyes.left.width,data[i].eyes.left.height),data[i].eyes.right.patch=new ImageData(new Uint8ClampedArray(data[i].eyes.right.patch),data[i].eyes.right.width,data[i].eyes.right.height),this.addData(data[i].eyes,data[i].screenPos,data[i].type)},webgazer.reg.RidgeWeightedReg.prototype.getData=function(){return this.dataClicks.data.concat(this.dataTrail.data)},webgazer.reg.RidgeWeightedReg.prototype.name="ridge"}(window),function(window){window.webgazer=window.webgazer||{},webgazer.reg=webgazer.reg||{},webgazer.mat=webgazer.mat||{},webgazer.util=webgazer.util||{};var ridgeParameter=Math.pow(10,-5),resizeWidth=10,resizeHeight=6,dataWindow=700,weights={X:[0],Y:[0]},trailDataWindow=10;function getEyeFeats(eyes){var resizedLeft=webgazer.util.resizeEye(eyes.left,resizeWidth,resizeHeight),resizedright=webgazer.util.resizeEye(eyes.right,resizeWidth,resizeHeight),leftGray=webgazer.util.grayscale(resizedLeft.data,resizedLeft.width,resizedLeft.height),rightGray=webgazer.util.grayscale(resizedright.data,resizedright.width,resizedright.height),histLeft=[];webgazer.util.equalizeHistogram(leftGray,5,histLeft);var histRight=[];webgazer.util.equalizeHistogram(rightGray,5,histRight);var leftGrayArray=Array.prototype.slice.call(histLeft),rightGrayArray=Array.prototype.slice.call(histRight);return leftGrayArray.concat(rightGrayArray)}webgazer.reg.RidgeRegThreaded=function(){this.screenXClicksArray=new webgazer.util.DataWindow(700),this.screenYClicksArray=new webgazer.util.DataWindow(700),this.eyeFeaturesClicks=new webgazer.util.DataWindow(700),this.screenXTrailArray=new webgazer.util.DataWindow(10),this.screenYTrailArray=new webgazer.util.DataWindow(10),this.eyeFeaturesTrail=new webgazer.util.DataWindow(10),this.dataClicks=new webgazer.util.DataWindow(700),this.dataTrail=new webgazer.util.DataWindow(700),this.worker=new Worker("ridgeWorker.js"),this.worker.onerror=function(err){console.log(err.message)},this.worker.onmessage=function(evt){weights.X=evt.data.X,weights.Y=evt.data.Y}},webgazer.reg.RidgeRegThreaded.prototype.addData=function(eyes,screenPos,type){eyes&&(eyes.left.blink||eyes.right.blink||this.worker.postMessage({eyes:getEyeFeats(eyes),screenPos:screenPos,type:type}))},webgazer.reg.RidgeRegThreaded.prototype.predict=function(eyesObj){if(console.log("LOGGING.."),!eyesObj)return null;for(var coefficientsX=weights.X,coefficientsY=weights.Y,eyeFeats=getEyeFeats(eyesObj),predictedX=0,predictedY=0,i=0;i<eyeFeats.length;i++)predictedX+=eyeFeats[i]*coefficientsX[i],predictedY+=eyeFeats[i]*coefficientsY[i];return predictedX=Math.floor(predictedX),predictedY=Math.floor(predictedY),console.log("PredicedX"),console.log(predictedX),console.log(predictedY),{x:predictedX,y:predictedY}},webgazer.reg.RidgeRegThreaded.prototype.setData=function(data){for(var i=0;i<data.length;i++)data[i].eyes.left.patch=new ImageData(new Uint8ClampedArray(data[i].eyes.left.patch),data[i].eyes.left.width,data[i].eyes.left.height),data[i].eyes.right.patch=new ImageData(new Uint8ClampedArray(data[i].eyes.right.patch),data[i].eyes.right.width,data[i].eyes.right.height),this.addData(data[i].eyes,data[i].screenPos,data[i].type)},webgazer.reg.RidgeRegThreaded.prototype.getData=function(){return this.dataClicks.data.concat(this.dataTrail.data)},webgazer.reg.RidgeRegThreaded.prototype.name="ridge"}(window),function(){function debugBoxWrite(para,stats){var str="";for(var key in stats)str+=key+": "+stats[key]+"\n";para.innerText=str}self.webgazer=self.webgazer||{},self.webgazer.util=self.webgazer.util||{},self.webgazer.mat=self.webgazer.mat||{},self.webgazer.util.Eye=function(patch,imagex,imagey,width,height){this.patch=patch,this.imagex=imagex,this.imagey=imagey,this.width=width,this.height=height},self.webgazer.util.DataWindow=function(windowSize,data){this.data=[],this.windowSize=windowSize,this.index=0,this.length=0,data&&(this.data=data.slice(data.length-windowSize,data.length),this.length=this.data.length)},self.webgazer.util.DataWindow.prototype.push=function(entry){return this.data.length<this.windowSize?(this.data.push(entry),this.length=this.data.length,this):(this.data[this.index]=entry,this.index=(this.index+1)%this.windowSize,this)},self.webgazer.util.DataWindow.prototype.get=function(ind){return this.data[this.getTrueIndex(ind)]},self.webgazer.util.DataWindow.prototype.getTrueIndex=function(ind){return this.data.length<this.windowSize?ind:(ind+this.index)%this.windowSize},self.webgazer.util.DataWindow.prototype.addAll=function(data){for(var i=0;i<data.length;i++)this.push(data[i])},self.webgazer.util.grayscale=function(imageData,imageWidth,imageHeight){return tracking.Image.grayscale(imageData,imageWidth,imageHeight,!1)},self.webgazer.util.equalizeHistogram=function(grayscaleImageSrc,step,destinationImage){return objectdetect.equalizeHistogram(grayscaleImageSrc,step,destinationImage)},self.webgazer.util.threshold=function(data,threshold){for(let i=0;i<data.length;i++)data[i]=data[i]>threshold?255:0;return data},self.webgazer.util.correlation=function(data1,data2){const length=Math.min(data1.length,data2.length);let count=0;for(let i=0;i<length;i++)data1[i]===data2[i]&&count++;return count/Math.max(data1.length,data2.length)},self.webgazer.util.resizeEye=function(eye,resizeWidth,resizeHeight){var canvas=document.createElement("canvas");canvas.width=eye.width,canvas.height=eye.height,canvas.getContext("2d").putImageData(eye.patch,0,0);var tempCanvas=document.createElement("canvas");return tempCanvas.width=resizeWidth,tempCanvas.height=resizeHeight,tempCanvas.getContext("2d").drawImage(canvas,0,0,canvas.width,canvas.height,0,0,resizeWidth,resizeHeight),tempCanvas.getContext("2d").getImageData(0,0,resizeWidth,resizeHeight)},self.webgazer.util.bound=function(prediction){prediction.x<0&&(prediction.x=0),prediction.y<0&&(prediction.y=0);var w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),h=Math.max(document.documentElement.clientHeight,window.innerHeight||0);return prediction.x>w&&(prediction.x=w),prediction.y>h&&(prediction.y=h),prediction},self.webgazer.util.DebugBox=function(interval){var updateInterval,localThis;this.para=document.createElement("p"),this.div=document.createElement("div"),this.div.appendChild(this.para),document.body.appendChild(this.div),this.buttons={},this.canvas={},this.stats={},localThis=this,setInterval(function(){debugBoxWrite(localThis.para,localThis.stats)},interval||300)},self.webgazer.util.DebugBox.prototype.set=function(key,value){this.stats[key]=value},self.webgazer.util.DebugBox.prototype.inc=function(key,incBy,init){this.stats[key]||(this.stats[key]=init||0),this.stats[key]+=incBy||1},self.webgazer.util.DebugBox.prototype.addButton=function(name,func){this.buttons[name]||(this.buttons[name]=document.createElement("button"),this.div.appendChild(this.buttons[name]));var button=this.buttons[name];this.buttons[name]=button,button.addEventListener("click",func),button.innerText=name},self.webgazer.util.DebugBox.prototype.show=function(name,func){this.canvas[name]||(this.canvas[name]=document.createElement("canvas"),this.div.appendChild(this.canvas[name]));var canvas=this.canvas[name];canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height),func(canvas)},self.webgazer.util.KalmanFilter=function(F,H,Q,R,P_initial,X_initial){this.F=F,this.Q=Q,this.H=H,this.R=R,this.P=P_initial,this.X=X_initial},self.webgazer.util.KalmanFilter.prototype.update=function(z){for(var add=numeric.add,sub=numeric.sub,inv=numeric.inv,identity=numeric.identity,mult=webgazer.mat.mult,transpose=webgazer.mat.transpose,X_p=mult(this.F,this.X),P_p=add(mult(mult(this.F,this.P),transpose(this.F)),this.Q),y=sub(z,mult(this.H,X_p)),S=add(mult(mult(this.H,P_p),transpose(this.H)),this.R),K=mult(P_p,mult(transpose(this.H),inv(S))),i=0;i<y.length;i++)y[i]=[y[i]];return this.X=add(X_p,mult(K,y)),this.P=mult(sub(identity(K.length),mult(K,this.H)),P_p),transpose(mult(this.H,this.X))[0]}}();var store_points_var=!1,xPast50=new Array(50),yPast50=new Array(50);function store_points(x,y,k){xPast50[k]=x,yPast50[k]=y}!function(window,undefined){console.log("initializing webgazer"),window.webgazer=window.webgazer||{},webgazer=webgazer||{},webgazer.tracker=webgazer.tracker||{},webgazer.reg=webgazer.reg||{},webgazer.params=webgazer.params||{},webgazer.params.videoScale=1;var videoElement=null,videoStream=null,videoElementCanvas=null;webgazer.params.videoElementId="webgazerVideoFeed",webgazer.params.videoElementCanvasId="webgazerVideoCanvas",webgazer.params.imgWidth=1280,webgazer.params.imgHeight=720,webgazer.params.clmParams=webgazer.params.clmParams||{useWebGL:!0},webgazer.params.camConstraints=webgazer.params.camConstraints||{video:!0},webgazer.params.smoothEyeBB=webgazer.params.smoothEyeBB||!0;var showGazeDot=!1,gazeDot=document.createElement("div");gazeDot.style.position="fixed",gazeDot.style.zIndex=99999,gazeDot.style.left="-5px",gazeDot.style.top="-5px",gazeDot.style.width="10px",gazeDot.style.height="10px",gazeDot.style.background="red",gazeDot.style.display="none",gazeDot.style.borderRadius="100%",gazeDot.style.opacity="0.7";var debugVideoLoc="",clockStart=performance.now();webgazer.params.dataTimestep=50;var paused=!1,nopCallback=function(data,time){},callback=nopCallback,eventTypes=["click","move"],moveClock=performance.now();webgazer.params.moveTickSize=50;var curTracker=new webgazer.tracker.ClmGaze,regs=[new webgazer.reg.RidgeReg],blinkDetector=new webgazer.BlinkDetector,curTrackerMap={clmtrackr:function(){return new webgazer.tracker.ClmGaze},trackingjs:function(){return new webgazer.tracker.TrackingjsGaze},js_objectdetect:function(){return new webgazer.tracker.Js_objectdetectGaze}},regressionMap={ridge:function(){return new webgazer.reg.RidgeReg},weightedRidge:function(){return new webgazer.reg.RidgeWeightedReg},threadedRidge:function(){return new webgazer.reg.RidgeRegThreaded},linear:function(){return new webgazer.reg.LinearReg}},localstorageLabel="webgazerGlobalData",settings={},data=[],defaults={data:[],settings:{}};function checkEyesInValidationBox(){var eyesObjs=curTracker.getEyePatches(videoElementCanvas,webgazer.params.imgWidth,webgazer.params.imgHeight),validationBox=document.getElementById("faceOverlay"),xPositions=!1,yPositions=!1;if(null!=validationBox&&eyesObjs){leftBound=107,topBound=59,rightBound=leftBound+117,bottomBound=topBound+117;var eyeLX=eyesObjs.left.imagex,eyeLY=eyesObjs.left.imagey,eyeRX=eyesObjs.right.imagex,eyeRY=eyesObjs.right.imagey;eyeLX>leftBound&&eyeLX<rightBound&&eyeRX>leftBound&&eyeRX<rightBound&&(xPositions=!0),eyeLY>topBound&&eyeLY<bottomBound&&eyeRY>topBound&&eyeRY<bottomBound&&(yPositions=!0),validationBox.style.border=xPositions&&yPositions?"solid green":"solid red"}}function checkCursor(){alert("Cursor at: "+cursorX+", "+cursorY)}function drawCoordinates(colour,x,y){var ctx=document.getElementById("plotting_canvas").getContext("2d");ctx.fillStyle=colour,ctx.beginPath(),ctx.arc(x,y,5,0,2*Math.PI,!0),ctx.fill()}function getPupilFeatures(canvas,width,height){if(canvas){paintCurrentFrame(canvas,width,height);try{return blinkDetector.detectBlink(curTracker.getEyePatches(canvas,width,height))}catch(err){return console.log(err),null}}}function paintCurrentFrame(canvas,width,height){var ctx;canvas.width!=width&&(canvas.width=width),canvas.height!=height&&(canvas.height=height),canvas.getContext("2d").drawImage(videoElement,0,0,canvas.width,canvas.height)}function getPrediction(regModelIndex){var predictions=[],features=getPupilFeatures(videoElementCanvas,webgazer.params.imgWidth,webgazer.params.imgHeight);if(0===regs.length)return console.log("regression not set, call setRegression()"),null;for(var reg in regs)predictions.push(regs[reg].predict(features));return regModelIndex!==undefined?null===predictions[regModelIndex]?null:{x:predictions[regModelIndex].x,y:predictions[regModelIndex].y}:0===predictions.length||null===predictions[0]?null:{x:predictions[0].x,y:predictions[0].y,all:predictions}}var smoothingVals=new webgazer.util.DataWindow(4),k=0;function loop(){var gazeData=getPrediction(),elapsedTime=performance.now()-clockStart;if(callback(gazeData,elapsedTime),gazeData&&showGazeDot){smoothingVals.push(gazeData);var x=0,y=0,len=smoothingVals.length;for(var d in smoothingVals.data)x+=smoothingVals.get(d).x,y+=smoothingVals.get(d).y;var pred=webgazer.util.bound({x:x/len,y:y/len});store_points_var&&(drawCoordinates("blue",pred.x,pred.y),store_points(pred.x,pred.y,k),50==++k&&(k=0)),gazeDot.style.transform="translate3d("+pred.x+"px,"+pred.y+"px,0)",checkEyesInValidationBox()}paused||requestAnimationFrame(loop)}var recordScreenPosition=function(x,y,eventType){if(!paused){var features=getPupilFeatures(videoElementCanvas,webgazer.params.imgWidth,webgazer.params.imgHeight);if(0===regs.length)return console.log("regression not set, call setRegression()"),null;for(var reg in regs)regs[reg].addData(features,[x,y],eventType)}},clickListener=function(event){recordScreenPosition(event.clientX,event.clientY,eventTypes[0])},moveListener=function(event){if(!paused){var now=performance.now();now<moveClock+webgazer.params.moveTickSize||(moveClock=now,recordScreenPosition(event.clientX,event.clientY,eventTypes[1]))}},addMouseEventListeners=function(){document.addEventListener("click",clickListener,!0),document.addEventListener("mousemove",moveListener,!0)},removeMouseEventListeners=function(){document.removeEventListener("click",clickListener,!0),document.removeEventListener("mousemove",moveListener,!0)};function loadGlobalData(){var storage=JSON.parse(window.localStorage.getItem(localstorageLabel))||defaults;for(var reg in settings=storage.settings,data=storage.data,regs)regs[reg].setData(storage.data)}function setGlobalData(){var storage={settings:settings,data:regs[0].getData()||data};window.localStorage.setItem(localstorageLabel,JSON.stringify(storage))}function clearData(){for(var reg in window.localStorage.set(localstorageLabel,undefined),regs)regs[reg].setData([])}function init(videoStream){if((videoElement=document.createElement("video")).id=webgazer.params.videoElementId,videoElement.autoplay=!0,console.log(videoElement),videoElement.style.display="none",!("srcObject"in videoElement))throw"Browser not supported by getUserMedia";videoElement.srcObject=videoStream,document.body.appendChild(videoElement),(videoElementCanvas=document.createElement("canvas")).id=webgazer.params.videoElementCanvasId,videoElementCanvas.style.display="none",document.body.appendChild(videoElementCanvas),addMouseEventListeners(),document.body.appendChild(gazeDot),paused=!1,clockStart=performance.now(),loop()}function setUserMediaVariable(){navigator.mediaDevices===undefined&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===undefined&&(navigator.mediaDevices.getUserMedia=function(constraints){var getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return getUserMedia?new Promise(function(resolve,reject){getUserMedia.call(navigator,options,resolve,reject)}):Promise.reject(new Error("Unfortunately, your browser does not support access to the webcam through the getUserMedia API. Try to use Google Chrome, Mozilla Firefox, Opera, or Microsoft Edge instead."))})}webgazer.begin=function(onFail){if(loadGlobalData(),onFail=onFail||function(){console.log("No stream")},debugVideoLoc)return init(debugVideoLoc),webgazer;var options=webgazer.params.camConstraints;return setUserMediaVariable(),navigator.mediaDevices.getUserMedia(options).then(function(stream){console.log("Video stream created"),videoStream=stream,init(stream)}).catch(function(err){onFail(),videoElement=null,videoStream=null}),"https:"!==window.location.protocol&&"localhost"!==window.location.hostname&&window.chrome&&alert("WebGazer works only over https. If you are doing local development you need to run a local server."),webgazer},webgazer.isReady=function(){return null!==videoElementCanvas&&(paintCurrentFrame(videoElementCanvas,webgazer.params.imgWidth,webgazer.params.imgHeight),videoElementCanvas.width>0)},webgazer.pause=function(){return paused=!0,webgazer},webgazer.resume=function(){return paused?(paused=!1,loop(),webgazer):webgazer},webgazer.end=function(){return paused=!0,document.body.removeChild(videoElement),document.body.removeChild(videoElementCanvas),setGlobalData(),webgazer},webgazer.stopVideo=function(){videoStream.getTracks()[0].stop();var faceBox=document.getElementById("faceOverlay");document.body.removeChild(faceBox);var overlay=document.getElementById("overlay");return document.body.removeChild(overlay),webgazer},webgazer.detectCompatibility=function(){var getUserMedia;return(navigator.mediaDevices.getUserMedia||navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia)!==undefined},webgazer.showPredictionPoints=function(bool){return showGazeDot=bool,gazeDot.style.left="-5px",gazeDot.style.display=bool?"block":"none",webgazer},webgazer.setStaticVideo=function(videoLoc){return debugVideoLoc=videoLoc,webgazer},webgazer.addMouseEventListeners=function(){return addMouseEventListeners(),webgazer},webgazer.removeMouseEventListeners=function(){return removeMouseEventListeners(),webgazer},webgazer.recordScreenPosition=function(x,y){return recordScreenPosition(x,y,eventTypes[0]),webgazer},webgazer.setTracker=function(name){if(curTrackerMap[name]===undefined){for(var t in console.log("Invalid tracker selection"),console.log("Options are: "),curTrackerMap)console.log(t);return webgazer}return curTracker=curTrackerMap[name](),webgazer},webgazer.setRegression=function(name){if(regressionMap[name]===undefined){for(var reg in console.log("Invalid regression selection"),console.log("Options are: "),regressionMap)console.log(reg);return webgazer}return data=regs[0].getData(),(regs=[regressionMap[name]()])[0].setData(data),webgazer},webgazer.addTrackerModule=function(name,constructor){curTrackerMap[name]=function(){return new constructor}},webgazer.addRegressionModule=function(name,constructor){regressionMap[name]=function(){return new constructor}},webgazer.addRegression=function(name){var newReg=regressionMap[name]();return data=regs[0].getData(),newReg.setData(data),regs.push(newReg),webgazer},webgazer.setGazeListener=function(listener){return callback=listener,webgazer},webgazer.clearGazeListener=function(){return callback=nopCallback,webgazer},webgazer.getTracker=function(){return curTracker},webgazer.getRegression=function(){return regs},webgazer.getCurrentPrediction=function(){return getPrediction()},webgazer.params.getEventTypes=function(){return eventTypes.slice()}}(window);